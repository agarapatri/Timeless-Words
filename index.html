<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Timeless Words</title>
  <link rel="stylesheet" href="assets/css/styles.css?v=17e6a869">
  <meta id="favicon-slot">
</head>

<body>

  <main class="container home">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1 class="title"><a href="./">Timeless Words</a></h1>
          <div class="muted">Collection of Vedic texts</div>
        </div>

        <div class="hero-actions">
          <a class="btn btn-outline thin btn-deep" href="views/search.html" aria-label="Go to Deep Search">
            <span class="icon" aria-hidden="true">
              <svg width="16" height="16" aria-hidden="true">
                <use href="assets/images/search.svg?v=17e6a869"></use>
              </svg>
            </span>
            Deep Search
          </a>
          <div id="menuSlot-home" class="menu-wrap"></div>
        </div>
      </div>

      <!-- Banner Section -->
      <section class="banner">
        <img src="assets/images/banner.avif?v=17e6a869" alt="Banner" class="banner-img">
      </section>

      <form class="search-bar home-filter" action="#" id="homeFilterForm">
        <input id="homeFilterInput" class="home-filter-input" type="search" name="q" placeholder="Filter library by title or author…" aria-label="Filter library" />

        <div class="type-filter">
          <button id="typeBtn" class="type-icon-btn type-trigger" type="button" aria-label="Filter by type" aria-haspopup="true" aria-expanded="false" aria-controls="typePanel">
            <!-- Filter icon (uses currentColor for light/dark) -->
            <svg class="icon" width="20" height="20" aria-hidden="true">
              <use href="assets/images/filter.svg?v=17e6a869#icon-filter"></use>
            </svg>
          </button>

          <!-- Popover -->
          <div id="typePanel" class="type-popover panel" hidden>
            <div class="panel-header">
              <div class="panel-title">Book Type</div>
              <button id="typeClear" class="btn ghost sm" type="button">Clear</button>
            </div>
            <div class="panel-body">
              <div class="type-list"><!-- checkboxes injected by JS --></div>
            </div>
          </div>
        </div>
      </form>

    </section>
    <section>
      <h2 class="section-title" style="margin-top:0px">
        Books <span id="booksCount" class="count" style="font-weight:400"></span>
      </h2>
      <div id="booksGrid" class="books-grid" aria-live="polite"></div>
      <div id="booksPager" class="pager"></div>
    </section>
  </main>

  <div id="footerSlot"></div>

  <script type="module">
    import { injectFooter } from './js/footer.js';
    injectFooter('#footerSlot');
  </script>


  <script src="./js/wasm_no_threads_fallback.js"></script>
  <script src="./js/lockdown_warning.js"></script>
  <script src="./js/sql_helpers/sql-wasm.js?v=17e6a869"></script>

  <script type="module" src="js/app.js?v=17e6a869"></script>
  <script type="module">
    import { query } from './js/db.js';

    const PAGE_SIZES = [25, 50, 100];

    window.addEventListener('DOMContentLoaded', async () => {
      window.Library?.injectMenu?.('#menuSlot-home');

      const state = {
        books: [],
        filtered: [],
        page: 1,
        perPage: PAGE_SIZES[0],
      };

      const grid = document.getElementById('booksGrid');
      const booksCount = document.getElementById('booksCount');
      const input = document.getElementById('homeFilterInput');

      const typeBtn = document.getElementById('typeBtn');
      const typePanel = document.getElementById('typePanel');
      const typeList = typePanel.querySelector('.type-list');
      const typeClear = document.getElementById('typeClear');

      const pager = document.getElementById('booksPager');
      let pagerReady = false;

      async function loadFromSQLite() {
        const typesOut = await query('SELECT code, label FROM work_types');
        const types = typesOut.rows
          .map(([code, label]) => ({ code, label }))
          .sort((a, b) => a.label.localeCompare(b.label, undefined, { sensitivity: 'base' }));

        const worksOut = await query(`
            SELECT w.work_id, w.slug, w.title_en, w.author, w.work_type_code,
                  (SELECT COUNT(*) FROM divisions d WHERE d.work_id = w.work_id) AS chapters,
                  (SELECT COUNT(*) FROM verses v WHERE v.work_id = w.work_id) AS verses
            FROM works w ORDER BY w.title_en
          `);
        const works = worksOut.rows.map(r => ({
          work_id: r[0],
          slug: r[1],
          title: r[2] || '',
          author: r[3] || 'Unknown',
          type: r[4] || '',
          chapters: r[5],
          verses: r[6],
          id: r[1] || String(r[0]),
          image: ''
        }));
        return { works, types };
      }

      try {
        const loaded = await loadFromSQLite();
        state.books = loaded.works;
        console.log('Loaded books:', state.books.length);
        console.log('Loaded work types:', loaded.types.length);

        const frag = document.createDocumentFragment();
        loaded.types.forEach(({ code, label }) => {
          const row = document.createElement('label');
          row.className = 'type-item';
          row.innerHTML = `
              <input type="checkbox" name="bookType" value="${code}" checked>
              <span>${label}</span>
            `;
          frag.appendChild(row);
        });
        typeList.appendChild(frag);
      } catch (e) {
        console.error('SQLite load error:', e);
        state.books = [];
      }

      function initialsFromTitle(title) {
        const words = (title || '').trim().split(/\s+/).filter(Boolean);
        if (words.length === 0) return '';
        if (words.length === 1) return words[0].slice(0, 2).toUpperCase();
        return words.slice(0, 2).map(w => w[0]).join('').toUpperCase();
      }

      function norm(s) {
        return String(s || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase();
      }

      function selectedTypes() {
        const set = new Set();
        typePanel.querySelectorAll('input[name="bookType"]:checked').forEach(cb => set.add(cb.value));
        return set;
      }

      function ensurePager() {
        if (!pager || pagerReady) return;
        pager.innerHTML = `
          <button id="booksPrevPage" type="button" class="btn ghost" aria-label="Previous page">‹ Prev</button>
          <span id="booksPageInfo" class="muted"></span>
          <button id="booksNextPage" type="button" class="btn ghost" aria-label="Next page">Next ›</button>
          <select id="booksPageSize" class="btn ghost" aria-label="Books per page">
            ${PAGE_SIZES.map(size => `<option value="${size}">${size}</option>`).join('')}
          </select>
        `;
        pagerReady = true;

        const prev = document.getElementById('booksPrevPage');
        const next = document.getElementById('booksNextPage');
        const size = document.getElementById('booksPageSize');

        prev?.addEventListener('click', () => {
          if (state.page > 1) {
            state.page -= 1;
            renderPage(true);
          }
        });
        next?.addEventListener('click', () => {
          const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.perPage));
          if (state.page < totalPages) {
            state.page += 1;
            renderPage(true);
          }
        });
        size?.addEventListener('change', () => {
          const val = Number(size.value);
          if (Number.isFinite(val) && val > 0) {
            state.perPage = val;
            state.page = 1;
            renderPage(true);
          }
        });
      }

      function updatePager(total, totalPages) {
        if (!pagerReady) return;
        const prev = document.getElementById('booksPrevPage');
        const next = document.getElementById('booksNextPage');
        const info = document.getElementById('booksPageInfo');
        const size = document.getElementById('booksPageSize');
        if (prev) prev.disabled = state.page <= 1 || total === 0;
        if (next) next.disabled = state.page >= totalPages || total === 0;
        if (info) info.textContent = total === 0 ? 'No books' : `Page ${state.page} / ${totalPages}`;
        if (size) size.value = String(state.perPage);
      }

      function renderBooks(list) {
        grid.innerHTML = '';
        if (!list.length) {
          const empty = document.createElement('div');
          empty.className = 'muted';
          empty.style.padding = '12px 0';
          empty.textContent = 'No books match your filters.';
          grid.appendChild(empty);
          return;
        }
        list.forEach(b => {
          const card = document.createElement('a');
          card.className = 'book-card';
          const bookParam = String(b.work_id || b.id || b.slug || '');
          card.href = `views/book.html?book=${encodeURIComponent(bookParam)}`;

          const initials = initialsFromTitle(b.title);
          const coverClass = b.image ? 'cover has-image' : 'cover';
          const styleAttr = b.image ? `style="background-image:url('${b.image}')"` : '';

          const ch = Number(b.chapters ?? 0);
          const vs = Number(b.verses ?? 0);
          const stats = `${ch} chapters · ${vs} verses`;

          card.innerHTML = `
              <div class="${coverClass} notranslate" translate="no" ${styleAttr} aria-hidden="true">${initials}</div>
              <div class="meta" style="min-width:0">
                <div class="book-title" title="${b.title}"
                     style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${b.title}</div>
                <div class="book-sub" title="${b.author || 'Unknown'}" style="font-size:14px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${b.author || 'Unknown'}</div>
                <div class="book-stats" style="font-size:14px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${stats}</div>
              </div>
            `;
          grid.appendChild(card);
        });
      }

      function renderPage(scrollTop = false) {
        ensurePager();
        state.filtered = state.filtered || [];
        const total = state.filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / state.perPage));
        state.page = Math.min(state.page, totalPages);
        const start = (state.page - 1) * state.perPage;
        const pageItems = state.filtered.slice(start, start + state.perPage);
        renderBooks(pageItems);
        updatePager(total, totalPages);
        if (booksCount) booksCount.textContent = `(${total})`;
        if (scrollTop) {
          const top = Math.max(0, (grid.offsetTop || 0) - 80);
          window.scrollTo({ top, behavior: 'smooth' });
        }
      }

      function applyFilters(queryText, { scrollTop = false } = {}) {
        const t = norm(queryText).trim();
        const selected = selectedTypes();
        state.filtered = state.books.filter(b => {
          const matchesText =
            !t || norm(b.title).includes(t) || norm(b.author).includes(t);
          const matchesType = selected.size === 0 || selected.has(b.type);
          return matchesText && matchesType;
        });
        state.page = 1;
        renderPage(scrollTop);
      }

      // Initial render
      state.filtered = state.books.slice();
      renderPage();

      // Open/close popover (click + ESC + click-away)
      function openType() {
        typePanel.hidden = false;
        typeBtn.setAttribute('aria-expanded', 'true');
        const first = typePanel.querySelector('input[type="checkbox"]');
        if (first) first.focus({ preventScroll: true });
        document.addEventListener('click', onAway, { capture: true });
        document.addEventListener('keydown', onEsc, { capture: true });
      }
      function closeType() {
        typePanel.hidden = true;
        typeBtn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', onAway, { capture: true });
        document.removeEventListener('keydown', onEsc, { capture: true });
      }
      function onAway(e) {
        if (typePanel.contains(e.target) || typeBtn.contains(e.target)) return;
        closeType();
      }
      function onEsc(e) { if (e.key === 'Escape') closeType(); }
      typeBtn.addEventListener('click', () => typePanel.hidden ? openType() : closeType());

      typePanel.addEventListener('change', () => applyFilters(input.value));
      typeClear.addEventListener('click', () => {
        typePanel.querySelectorAll('input[name="bookType"]').forEach(cb => cb.checked = false);
        applyFilters(input.value, { scrollTop: true });
      });

      input.addEventListener('input', () => applyFilters(input.value));
      document.getElementById('homeFilterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        applyFilters(input.value, { scrollTop: true });
      });
    });
  </script>

  <script>
    // Make sure the menu shows even if data loading fails
    window.addEventListener('DOMContentLoaded', () => {
      window.Library?.injectMenu?.('#menuSlot-home');
    });
  </script>

</body>

</html>
