<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapter — Timeless Words</title>

  <!-- Correct path -->
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    /* Minimal page-specific styles */
    .chapter-page { max-width: 960px; margin: 0 auto; padding: 24px; }
    .crumbs { display: flex; gap: 8px; align-items: center; color: var(--muted); margin-bottom: 8px; }
    .crumbs a { color: inherit; text-decoration: none; }
    .titlebar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: space-between; }
    .titlebar .title { margin: 8px 0; }
    .view-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface-2);
      font: inherit;
    }
    .results-list { list-style: none; padding: 0; margin: 16px 0 40px; display: grid; gap: 12px; }
    .results-list > li a { display: block; padding: 16px; border-radius: 12px; background: var(--surface); border: 1px solid var(--border); text-decoration: none; color: inherit; }
    .results-list .line + .line { margin-top: 6px; }
    .ref { font-weight: 600; font-variant-numeric: tabular-nums; }
    .muted { color: var(--muted); margin: 0; }
  </style>
</head>

<body>
  <main class="container chapter-page">
    <nav class="crumbs" id="crumbs"></nav>

    <!-- Title row with single-select filter -->
    <div class="titlebar">
      <h1 class="title" id="chapterTitle">Chapter</h1>
      <select id="viewMode" class="view-select" aria-label="Filter verse view">
        <option value="en" selected>English translation</option>
        <option value="dev">Devanāgarī</option>
        <option value="iast">IAST</option>
        <option value="wfw">Word-for-word</option>
      </select>
    </div>

    <p class="muted" id="chapterMeta"></p>
    <ol id="verseList" class="results-list"></ol>
  </main>

  <!-- App helpers (kept) -->
  <script src="assets/app.js"></script>
  <!-- sql.js for SQLite in-browser access -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // Query param helper
    function qp(name) { return new URLSearchParams(location.search).get(name); }

    // Persist the selected mode
    function getSavedMode() {
      try { return localStorage.getItem('tw.viewMode') || 'en'; } catch { return 'en'; }
    }
    function saveMode(mode) { try { localStorage.setItem('tw.viewMode', mode); } catch {} }

    window.addEventListener('DOMContentLoaded', async () => {
      const bookParam = qp('book');
      const divisionParam = qp('d');
      const chapterNum = Number(qp('c') || 1);

      async function loadDb() {
        const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
        const res = await fetch(`data/library.sqlite?v=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to fetch SQLite');
        const buf = new Uint8Array(await res.arrayBuffer());
        return new SQL.Database(buf);
      }

      function findWork(db, token) {
        const isNumeric = /^\d+$/.test(token || '');
        if (isNumeric) {
          const out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE work_id=${Number(token)} LIMIT 1`);
          if (out[0]?.values?.length) return out[0].values[0];
        }
        const esc = String(token || '').replace(/'/g, "''");
        let out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE slug='${esc}' LIMIT 1`);
        if (out[0]?.values?.length) return out[0].values[0];
        out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE lower(title_en)=lower('${esc}') LIMIT 1`);
        return out[0]?.values?.[0] || null;
      }

      const db = await loadDb();
      const work = findWork(db, bookParam);
      if (!work) { console.error('Work not found', bookParam); return; }
      const work_id = work[0], slug = work[1], title = work[2] || '';

      // Resolve division (chapter)
      let division_id, division_label, division_ord;
      if (divisionParam) {
        const di = db.exec(`SELECT division_id, ordinal, label FROM divisions WHERE division_id=${Number(divisionParam)} AND work_id=${Number(work_id)} LIMIT 1`);
        const rowd = di[0]?.values?.[0];
        if (!rowd) { console.error('Division not found by id', { work_id, divisionParam }); return; }
        division_id = rowd[0];
        division_ord = rowd[1];
        division_label = rowd[2] || `Chapter ${rowd[1]}`;
      } else {
        const di = db.exec(`SELECT division_id, ordinal, label FROM divisions WHERE work_id=${Number(work_id)} AND ordinal=${Number(chapterNum)} LIMIT 1`);
        const rowd = di[0]?.values?.[0];
        if (!rowd) { console.error('Division not found by ordinal', { work_id, chapterNum }); return; }
        division_id = rowd[0];
        division_ord = rowd[1];
        division_label = rowd[2] || `Chapter ${rowd[1]}`;
      }

      // Header + crumbs
      document.getElementById('chapterTitle').textContent = `${title} — Chapter ${division_ord || chapterNum}`;
      const crumbs = document.getElementById('crumbs');
      const backBookParam = String(work_id);
      crumbs.innerHTML = `
        <a href="index.html">Timeless Words</a><span>›</span>
        <a href="book.html?book=${encodeURIComponent(backBookParam)}">${title}</a><span>›</span>
        <span>Chapter ${chapterNum}</span>
      `;

      // Load verses for this division using the wide view
      const versesOut = db.exec(`
        SELECT vw.verse_id, vw.ref_citation, vs.ordinal,
               COALESCE(vw.sa_deva, '') AS sa_deva,
               COALESCE(vw.sa_iast, '') AS sa_iast,
               COALESCE(vw.en_translation, '') AS en
        FROM verse_texts_wide vw
        JOIN verses vs ON vs.verse_id = vw.verse_id
        WHERE vw.work_id = ${Number(work_id)} AND vw.division_id = ${Number(division_id)}
        ORDER BY vs.ordinal
      `);
      const rows = (versesOut[0]?.values || []).map(r => ({
        verse_id: r[0],
        ref: r[1],
        ordinal: r[2],
        sa_deva: r[3],
        sa_iast: r[4],
        en: r[5]
      }));

      // Build WFW map for this division
      const wfwMap = new Map();
      const wfwOut = db.exec(`
        SELECT t.verse_id, t.pos, t.surface,
               (SELECT gloss FROM verse_glosses g WHERE g.verse_id = t.verse_id AND g.surface = t.surface LIMIT 1) AS gloss
        FROM tokens t
        JOIN verses v ON v.verse_id = t.verse_id
        WHERE v.division_id = ${Number(division_id)}
        ORDER BY t.verse_id, t.pos
      `);
      if (wfwOut[0]) {
        for (const [verse_id, pos, surface, gloss] of wfwOut[0].values) {
          const key = Number(verse_id);
          if (!wfwMap.has(key)) wfwMap.set(key, []);
          wfwMap.get(key).push([surface || '', gloss || '']);
        }
      }

      // Meta counts
      document.getElementById('chapterMeta').textContent = `${rows.length} ${rows.length === 1 ? 'verse' : 'verses'}`;

      // Render
      const list = document.getElementById('verseList');
      const modeSel = document.getElementById('viewMode');
      const initialMode = getSavedMode();
      modeSel.value = ['en','dev','iast','wfw'].includes(initialMode) ? initialMode : 'en';

      function asSnippet(row, mode) {
        if (mode === 'dev') return row.sa_deva || '';
        if (mode === 'iast') return row.sa_iast || '';
        if (mode === 'wfw') {
          const pairs = wfwMap.get(Number(row.verse_id)) || [];
          return pairs.map(([sk, en]) => `${sk} — ${en}`).join('; ');
        }
        return row.en || '';
      }

      function render() {
        const mode = modeSel.value;
        list.innerHTML = '';
        rows.forEach(r => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `verse.html?book=${encodeURIComponent(backBookParam)}&d=${encodeURIComponent(division_id)}&v=${encodeURIComponent(r.ordinal)}`;
          const snippet = asSnippet(r, mode);
          // ref: use work short ID equivalent; we don't have short here, so display first two letters of title
          const short = (title || '').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
          a.innerHTML = `
            <div class="line"><span class="ref notranslate" translate="no">${short} ${division_ord || chapterNum}.${r.ordinal}</span></div>
            <div class="line">${(snippet || '').replace(/\n/g, '<br>')}</div>
          `;
          li.appendChild(a);
          list.appendChild(li);
        });
      }

      modeSel.addEventListener('change', () => { saveMode(modeSel.value); render(); });
      render();
    });
  </script>
</body>
</html>
