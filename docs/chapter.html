<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapter — Timeless Words</title>

  <!-- Correct path -->
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    /* Minimal page-specific styles */
    .chapter-page { max-width: 960px; margin: 0 auto; padding: 24px; }
    .crumbs { display: flex; gap: 8px; align-items: center; color: var(--muted); margin-bottom: 8px; }
    .crumbs a { color: inherit; text-decoration: none; }
    .titlebar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: space-between; }
    .titlebar .title { margin: 8px 0; }
    .view-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface-2);
      font: inherit;
    }
    .results-list { list-style: none; padding: 0; margin: 16px 0 40px; display: grid; gap: 12px; }
    .results-list > li a { display: block; padding: 16px; border-radius: 12px; background: var(--surface); border: 1px solid var(--border); text-decoration: none; color: inherit; }
    .results-list .line + .line { margin-top: 6px; }
    .ref { font-weight: 600; font-variant-numeric: tabular-nums; }
    .muted { color: var(--muted); margin: 0; }
  </style>
</head>

<body>
  <main class="container chapter-page">
    <nav class="crumbs" id="crumbs"></nav>

    <!-- Title row with single-select filter -->
    <div class="titlebar">
      <h1 class="title" id="chapterTitle">Chapter</h1>
      <select id="viewMode" class="view-select" aria-label="Filter verse view">
        <option value="en" selected>English translation</option>
        <option value="dev">Devanāgarī</option>
        <option value="iast">IAST</option>
        <option value="wfw">Word-for-word</option>
      </select>
    </div>

    <p class="muted" id="chapterMeta"></p>
    <ol id="verseList" class="results-list"></ol>
  </main>

  <!-- Load your embedded data bundle FIRST -->
  <script src="assets/data-bundle.js"></script>
  <!-- Your general app helpers (optional to keep; we don't depend on it here) -->
  <script src="assets/app.js"></script>

  <script>
    // Query param helper
    function qp(name) { return new URLSearchParams(location.search).get(name); }

    // Persist the selected mode
    function getSavedMode() {
      try { return localStorage.getItem('tw.viewMode') || 'en'; } catch { return 'en'; }
    }
    function saveMode(mode) { try { localStorage.setItem('tw.viewMode', mode); } catch {} }

    window.addEventListener('DOMContentLoaded', () => {
      if (!window.DATA) {
        console.error('DATA bundle not loaded.');
        return;
      }
      const { library, rows } = window.DATA;

      const bookId = qp('book') || (library[0] && library[0].id);
      const chapterNum = Number(qp('c') || 1);

      const bookMeta = library.find(b => b.id === bookId) || library[0];
      const allRows = rows[bookMeta.id] || [];
      const chapterRows = allRows
        .filter(r => Number(r.chapter) === chapterNum)
        .sort((a, b) => Number(a.verse) - Number(b.verse));

      // Header + crumbs
      document.getElementById('chapterTitle').textContent =
        `${bookMeta.title} — Chapter ${chapterNum}`;
      document.getElementById('chapterMeta').textContent =
        `${chapterRows.length} ${chapterRows.length === 1 ? 'verse' : 'verses'}`;

      const crumbs = document.getElementById('crumbs');
      crumbs.innerHTML = `
        <a href="index.html">Timeless Words</a><span>›</span>
        <a href="book.html?book=${encodeURIComponent(bookMeta.id)}">${bookMeta.title}</a><span>›</span>
        <span>Chapter ${chapterNum}</span>
      `;

      const list = document.getElementById('verseList');
      const modeSel = document.getElementById('viewMode');

      // Initialize selector from saved preference, default to English
      const initialMode = getSavedMode();
      modeSel.value = ['en','dev','iast','wfw'].includes(initialMode) ? initialMode : 'en';

      function asSnippet(row, mode) {
        if (mode === 'dev') return (row.original_sanskrit || row.devanagari || row.sanskrit || '').toString().trim();
        if (mode === 'iast') return (row.iast_transliteration || row.iast || row.transliteration || '').toString().trim();
        if (mode === 'wfw') {
          const pairs = Array.isArray(row.word_by_word) ? row.word_by_word
                    : Array.isArray(row.word_for_word) ? row.word_for_word : [];
          return pairs.map(p => {
            const sk = Array.isArray(p) ? (p[0] ?? '') : (p.sanskrit ?? '');
            const en = Array.isArray(p) ? (p[1] ?? '') : (p.english ?? '');
            return `${sk} — ${en}`;
          }).join('; ');
        }
        return (row.translation_en || row.translation || row.en || '').toString().trim();
      }

      function render() {
        const mode = modeSel.value;
        list.innerHTML = '';
        chapterRows.forEach(r => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `verse.html?book=${encodeURIComponent(bookMeta.id)}&c=${encodeURIComponent(chapterNum)}&v=${encodeURIComponent(r.verse)}`;
          const snippet = asSnippet(r, mode);
          a.innerHTML = `
            <div class="line"><span class="ref notranslate" translate="no">${bookMeta.id.toUpperCase()} ${chapterNum}.${r.verse}</span></div>
            <div class="line">${(snippet || '').replace(/\n/g, '<br>')}</div>
          `;
          li.appendChild(a);
          list.appendChild(li);
        });
      }

      modeSel.addEventListener('change', () => { saveMode(modeSel.value); render(); });
      render(); // initial
    });
  </script>
</body>
</html>
