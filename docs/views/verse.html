<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verse — Timeless Words</title>
  <link rel="stylesheet" href="../assets/css/styles.css?v={{VERSION}}">
  <meta id="favicon-slot">
</head>

<body>


  <main class="container verse-page">
    <nav class="crumbs" id="crumbs" aria-label="Breadcrumb"></nav>
    <div class="verse-head" style="position:relative;">
      <h1 id="ref" class="verse-ref notranslate" translate="no" style="margin:0"></h1>
      <div id="menuSlot-verse" class="menu-wrap" style="position:absolute; right:0; top:50%; transform:translateY(-50%);"></div>
    </div>

    <section class="verse-block">
      <h2>Sanskrit (Devanāgarī)</h2>
      <pre id="devanagari" class="devanagari"></pre>
    </section>
    <section class="verse-block">
      <h2>Sanskrit (IAST)</h2>
      <pre id="iast" class="iast"></pre>
    </section>
    <section class="verse-block">
      <h2>Word-for-word</h2>
      <ul id="wfw" class="wfw"></ul>
    </section>
    <section class="verse-block">
      <h2>Translation</h2>
      <p id="translation" class="translation"></p>
    </section>

    <div class="pager" id="verseNav" style="justify-content: space-between;">
      <a id="prevVerse" class="btn ghost nav-btn" href="#">‹ Prev verse</a>
      <a id="nextVerse" class="btn ghost nav-btn" href="#">Next verse ›</a>
    </div>
  </main>
  <div id="footerSlot"></div>

  <script type="module">
    import { injectFooter } from '../js/footer.js';
    injectFooter('#footerSlot');
  </script>

  <script src="../js/sql_helpers/sql-wasm.js"></script>

  <script type="module" src="../js/app.js?v={{VERSION}}"></script>
  <script type="module">
    import { loadDb, findWork, query } from '../js/db.js';

    if (window.Library && window.Library.injectMenu) window.Library.injectMenu('#menuSlot-verse');
    window.addEventListener('DOMContentLoaded', async () => {
      const p = new URLSearchParams(location.search);
      const bookParam = p.get('book'); // numeric work_id preferred
      const divisionParam = p.get('d');
      const chapterParam = p.get('c'); // fallback
      const verseOrd = Number(p.get('v') || 1);

      try {
        const db = await loadDb();
        const work = await findWork(bookParam);
        if (!work) throw new Error('Work not found: ' + bookParam);
        const work_id = work[0];
        const title = work[2] || '';

        // Resolve division (chapter)
        let division_id, division_ord, division_label;
        if (divisionParam) {
          const di = await db.query(
            `SELECT division_id, ordinal, label
              FROM divisions
              WHERE division_id = $div AND work_id = $work
              LIMIT 1`,
            { $div: Number(divisionParam), $work: Number(work_id) }
          );
          const rowd = di.rows?.[0];
          if (!rowd) throw new Error('Division not found (by id)');
          division_id = rowd[0];
          division_ord = rowd[1];
          division_label = rowd[2] || '';
        } else {
          const ord = Number(chapterParam || 1);
          const di = await db.query(
            `SELECT division_id, ordinal, label
              FROM divisions
              WHERE work_id = $work AND ordinal = $ord
              LIMIT 1`,
            { $work: Number(work_id), $ord: Number(ord) }
          );
          const rowd = di.rows?.[0];
          if (!rowd) throw new Error('Division not found (by ordinal)');
          division_id = rowd[0];
          division_ord = rowd[1];
          division_label = rowd[2] || '';
        }

        // Find verse row by ordinal within this division
        const vrow = await db.query(
          `SELECT verse_id, ref_citation, ordinal
            FROM verses
            WHERE work_id = $work
              AND division_id = $div
              AND ordinal = $ord
            LIMIT 1`,
          { $work: Number(work_id), $div: Number(division_id), $ord: Number(verseOrd) }
        );
        const v = vrow.rows?.[0];
        if (!v) throw new Error('Verse not found');
        const verse_id = v[0];
        const ref = v[1] || `${division_ord}.${verseOrd}`;

        // Load verse texts from the wide view
        const trow = await db.query(
          `SELECT
              COALESCE(sa_deva, '') AS sa_deva,
              COALESCE(sa_iast, '') AS sa_iast,
              COALESCE(en_translation, '') AS en_translation
            FROM verse_texts_wide
            WHERE verse_id = $id
            LIMIT 1`,
          { $id: Number(verse_id) }
        );
        const tvals = trow.rows?.[0] || ['', '', ''];
        const sa_deva = tvals[0];
        const sa_iast = tvals[1];
        const en = tvals[2];

        // Word-for-word from tokens + verse_glosses
        const wfwOut = await db.query(
          `SELECT
              t.pos,
              t.surface,
              (SELECT gloss
                FROM verse_glosses g
                WHERE g.verse_id = t.verse_id
                  AND g.surface  = t.surface
                LIMIT 1) AS gloss
            FROM tokens t
            WHERE t.verse_id = $id
            ORDER BY t.pos`,
          { $id: Number(verse_id) }
        );
        const pairs = (wfwOut.rows || []).map(r => [r[1] || '', r[2] || '']);

        // Render header + crumbs
        const short = (title || '').split(/\s+/).map(s => s[0]).join('').slice(0, 2).toUpperCase();
        document.getElementById('ref').textContent = `${short} ${ref}`;
        const crumbs = document.getElementById('crumbs');
        const chapterLabel = division_label ? division_label : `Chapter ${division_ord}`;
        crumbs.innerHTML = `
          <a href="../index.html">Timeless Words</a>
          <span class="crumbs__sep" aria-hidden="true">›</span>
          <a href="book.html?book=${encodeURIComponent(String(work_id))}">${title}</a>
          <span class="crumbs__sep" aria-hidden="true">›</span>
          <a href="chapter.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(division_id))}">${chapterLabel}</a>
          <span class="crumbs__sep" aria-hidden="true">›</span>
          <span aria-current="page">Verse ${ref}</span>
        `;

        // Fill sections
        document.getElementById('devanagari').textContent = sa_deva || '';
        document.getElementById('iast').textContent = sa_iast || '';

        const wfw = document.getElementById('wfw');
        wfw.innerHTML = '';
        pairs.forEach(([sk, gloss]) => {
          if (!sk && !gloss) return;
          const li = document.createElement('li');
          li.innerHTML = `<span class="sk">${sk}</span> &mdash; <span class="en">${gloss}</span>`;
          wfw.appendChild(li);
        });
        document.getElementById('translation').textContent = en || '';

        // Prev/Next verse navigation across chapters
        const prevQ = await db.query(
          `SELECT vs.verse_id, d.division_id, d.ordinal AS cord, vs.ordinal AS vord
            FROM verses vs
            JOIN divisions d ON d.division_id = vs.division_id
            WHERE vs.work_id = $work
              AND (d.ordinal < $cord OR (d.ordinal = $cord AND vs.ordinal < $vord))
            ORDER BY d.ordinal DESC, vs.ordinal DESC
            LIMIT 1`,
          { $work: Number(work_id), $cord: Number(division_ord), $vord: Number(verseOrd) }
        );
        const nextQ = await db.query(
          `SELECT vs.verse_id, d.division_id, d.ordinal AS cord, vs.ordinal AS vord
            FROM verses vs
            JOIN divisions d ON d.division_id = vs.division_id
            WHERE vs.work_id = $work
              AND (d.ordinal > $cord OR (d.ordinal = $cord AND vs.ordinal > $vord))
            ORDER BY d.ordinal ASC, vs.ordinal ASC
            LIMIT 1`,
          { $work: Number(work_id), $cord: Number(division_ord), $vord: Number(verseOrd) }
        );
        const prev = prevQ.rows?.[0];
        const next = nextQ.rows?.[0];

        const prevEl = document.getElementById('prevVerse');
        const nextEl = document.getElementById('nextVerse');
        if (prev) {
          const dId = prev[1], vOrd = prev[3];
          prevEl.href = `verse.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(dId))}&v=${encodeURIComponent(String(vOrd))}`;
          prevEl.style.visibility = 'visible';
        } else {
          prevEl.style.visibility = 'hidden';
        }
        if (next) {
          const dId = next[1], vOrd = next[3];
          nextEl.href = `verse.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(dId))}&v=${encodeURIComponent(String(vOrd))}`;
          nextEl.style.visibility = 'visible';
        } else {
          nextEl.style.visibility = 'hidden';
        }
      } catch (err) {
        console.error('Verse load error', err);
      }
    });
  </script>

</body>

</html>
