<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Search – Timeless Words</title>
  <link rel="stylesheet" href="assets/styles.css?v={{VERSION}}">
  <meta id="favicon-slot">
</head>

<body>
  <main class="container search-page">

    <a class="back-link" href="index.html">← Back</a>

    <div class="titlebar">
      <h1 class="title">Deep Search</h1>

      <button id="search-help-btn" type="button" class="help-btn" aria-label="Search help" aria-haspopup="dialog" aria-expanded="false" aria-controls="search-help-popover">?</button>

      <label id="btn-semantic" class="ios-switch compact" data-mode="off" title="Switch to semantic search">
        <span class="label">by meaning</span>
        <input type="checkbox" />
        <span class="track"><span class="thumb"></span></span>
      </label>

      <div class="hero-actions">
        <div id="menuSlot-search" class="menu-wrap"></div>
      </div>

      <div id="search-help-popover" class="help-popover" role="dialog" aria-modal="true" aria-labelledby="search-help-title" hidden>
        <div class="help-header">
          <h2 id="search-help-title">Search tips</h2>
          <button type="button" class="close-btn" aria-label="Close">✕</button>
        </div>
        <div class="help-content">

          <p><strong>Basics</strong><br>Type words anywhere: <code>vishnu paramatma</code></p>
          <p><strong>Phrases</strong><br>Exact sequence: <code>"śiva paramātmā"</code></p>
          <p><strong>Wildcards</strong><br>Prefix: <code>rudr*</code></p>
          <p><strong>Regex (advanced)</strong><br>Wrap in slashes: <code>/viṣṇu.*nārāyaṇa/</code> &nbsp; Alt: <code>/śiva|śambhu/</code></p>
          <hr>

          <!-- Accordion trigger -->
          <button id="regex-acc-btn" class="acc-btn" aria-expanded="false" aria-controls="regex-acc-panel">
            Advanced tips
            <svg class="chev" width="18" height="18" aria-hidden="true">
              <use href="icons/chev.svg?v={{VERSION}}#icon-chev"></use>
            </svg>
          </button>

          <!-- Accordion panel -->
          <div id="regex-acc-panel" class="acc-panel" hidden style="margin-top:8px;">
            <ul class="cheatsheet" style="columns:1; gap:24px; list-style:none; padding:0; margin:10px 0;">
              <li><code>śiva</code> – literal</li>
              <li><code>ś.va</code> – dot = any char</li>
              <li><code>viṣṇu.*parama</code> – any chars between</li>
              <li><code>rudr+a</code> – one or more</li>
              <li><code>śiv?a</code> – zero or one</li>
              <li><code>śiva|śambhu</code> – alternation</li>
              <li><code>(hari|viṣṇu)nāma</code> – grouping</li>
              <li><code>[sr]āma</code> – character class</li>
              <li><code>[0-9]+</code> – numbers</li>
              <li><code>[^a-zA-Z]</code> – not a letter</li>
              <li><code>^namaḥ</code> – start of line</li>
              <li><code>śivāya$</code> – end of line</li>
              <li><code>\bparama\b</code> – whole word</li>
              <li><code>\Bparama</code> – inside word</li>
              <li><code>a{2,4}</code> – 2 to 4 times</li>
              <li><code>(śrī\s)?kṛṣṇa</code> – optional group</li>
              <li><code>\(1\.2\.19\)</code> – escape specials</li>
              <li><code>śiva(?=.*parama)</code> – lookahead</li>
              <li><code>śiva(?! paramātmā)</code> – neg. lookahead</li>
              <li><code>(?i)viṣṇu</code> – case-insensitive</li>
            </ul>

            <p class="dim" style="color:#64748b; margin-top:12px;">
              Learn & test interactively:
              <a href="https://regex101.com/" target="_blank" rel="noopener">regex101.com</a>
            </p>
          </div>
        </div>
      </div>
      </h1>
    </div>

    <div class="search-layout">
      <section class="search-main">

        <form id="filters" class="filters" onsubmit="return false;">
          <div class="filter" style="grid-column: span 12; position:relative;">
            <input id="q" type="search" placeholder="Search (regex, phrases, wildcards)…" aria-label="Deep search">
          </div>

          <div class="chipbar" id="chipbar">
            <button type="button" class="active" data-scope="deva" aria-pressed="true">Devanāgarī</button>
            <button type="button" class="active" data-scope="iast" aria-pressed="true">IAST</button>
            <button type="button" class="active" data-scope="trans" aria-pressed="true">Translation</button>
            <button type="button" class="active" data-scope="wfw" aria-pressed="true">Word-for-word</button>
          </div>
        </form>

        <script src="assets/sql_helpers/sql-wasm.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js"></script>
        <script type="module" src="assets/encoder.js?v={{VERSION}}"></script>

        <script>
          (function () {
            const btn = document.getElementById('search-help-btn');
            const pop = document.getElementById('search-help-popover');
            const inner = pop?.querySelector('.help-inner');
            const close = pop?.querySelector('.close-btn');
            const input = document.getElementById('q');
            const accBtn = document.getElementById('regex-acc-btn');
            const accPanel = document.getElementById('regex-acc-panel');

            if (btn && pop) {
              let open = false;
              function show() { pop.hidden = false; open = true; btn.setAttribute('aria-expanded', 'true'); requestAnimationFrame(() => inner?.focus()); document.addEventListener('keydown', onKey); document.addEventListener('click', onDocClick, true); }
              function hide() { pop.hidden = true; open = false; btn.setAttribute('aria-expanded', 'false'); document.removeEventListener('keydown', onKey); document.removeEventListener('click', onDocClick, true); btn.focus(); }
              function onKey(e) { if (e.key === 'Escape') hide(); }
              function onDocClick(e) { if (!pop.contains(e.target) && e.target !== btn) hide(); }
              btn.addEventListener('click', () => pop.hidden ? show() : hide());
              close?.addEventListener('click', hide);
            }

            // Accordion
            if (accBtn && accPanel) {
              accBtn.addEventListener('click', () => {
                const expanded = accBtn.getAttribute('aria-expanded') === 'true';
                accBtn.setAttribute('aria-expanded', String(!expanded));
                accPanel.hidden = expanded;
                const chev = accBtn.querySelector('.chev');
                if (chev) chev.style.transform = expanded ? 'rotate(0deg)' : 'rotate(90deg)';
              });
            }

            // Rotating placeholder tips
            if (input) {
              const tips = [
                'Search (regex, phrases, wildcards)…',
                'Try any word: "vishnu paramatma"',
                'Try phrase: "śiva paramātmā"',
                'Try prefix: rudr*',
                'Try regex: /viṣṇu.*nārāyaṇa/'
              ];
              let i = 0;
              setInterval(() => {
                if (document.activeElement === input) return;
                i = (i + 1) % tips.length;
                input.placeholder = tips[i];
              }, 3000);
            }
          })();
        </script>

        <!-- Inline download panel (hidden until used) -->
        <section id="tw-sem-panel" style="display:none; margin-top:10px;">
          <div style="padding:10px; border:1px solid var(--border); border-radius:10px;">
            <strong>Downloading semantic pack…</strong>
            <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
              <progress id="tw-sem-progress" value="0" max="100" style="flex:1;"></progress>
              <span id="tw-sem-pct" class="muted">0%</span>
            </div>
            <div id="tw-sem-status" class="muted" style="margin-top:6px;">Preparing…</div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="tw-sem-cancel" class="secondary">Cancel</button>
              <button id="tw-sem-delete" class="secondary">Delete Pack</button>
              <span id="tw-sem-size" class="muted" style="margin-left:auto;"></span>
            </div>
          </div>
        </section>

        <div id="resultsInfo" class="results-info" aria-live="polite"></div>
        <ol id="results" class="results-list" aria-live="polite"></ol>
      </section>

      <aside class="search-side">
        <!-- Filter by book type -->
        <div class="filter" id="fTypes">
          <div class="panel-header2">
            <div class="panel-title">Book Type</div>
            <button id="typeClear" class="btn ghost sm" type="button">Clear</button>
          </div>
          <div class="book-box">
            <div id="typeChecklist" class="checklist"></div>
          </div>
        </div>

        <!-- Filter by specific books -->
        <div class="filter" id="fBooks">
          <div class="panel-header3">
            <div class="panel-title">Book</div>
            <button id="typeClear" class="btn ghost sm" type="button">Clear</button>
          </div>
          <div class="book-box">
            <div class="filter">
              <input type="search" id="bookSearch" placeholder="Search books…" aria-label="Search books">
            </div>
            <div id="bookChecklist" class="checklist"></div>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>Inspired by <a href="https://vedabase.io/en/" target="_blank" rel="noopener">vedabase.io</a></small>
    </div>
  </footer>

  <!-- sql.js loader (classic, must come first) -->
  <script src="assets/sql_helpers/sql-wasm.js"></script>

  <script type="module">
    import "./assets/app.js?v={{VERSION}}";
    window.Library?.injectMenu("#menuSlot-search");
  </script>

  <!-- search logic is an ES module because it imports ./db.js -->
  <script type="module" src="assets/search.js?v={{VERSION}}"></script>

  <!-- Semantic search support (also modules) -->
  <script type="module" src="assets/semantic_downloader.js?v={{VERSION}}"></script>

  <script type="module">
    import { SemanticInstall } from './assets/semantic_downloader.js';

    // Wait for all other scripts to finish loading
    window.addEventListener('load', () => {
      setTimeout(() => {
        const panel = new SemanticInstall({
          panelId: 'tw-sem-panel',
          barId: 'tw-sem-progress',
          pctId: 'tw-sem-pct',
          statusId: 'tw-sem-status',
          cancelId: 'tw-sem-cancel',
          deleteId: 'tw-sem-delete',
          sizeId: 'tw-sem-size',
        });

        const toggle = document.getElementById('btn-semantic');

        // If the element doesn't exist or isn't our switch, recreate it
        if (!toggle || !toggle.querySelector('.track')) {
          console.log('Recreating semantic toggle...');

          const helpBtn = document.getElementById('search-help-btn');
          const container = helpBtn.parentNode;

          const existing = document.getElementById('btn-semantic');
          if (existing) existing.remove();

          const newToggle = document.createElement('label');
          newToggle.id = 'btn-semantic';
          newToggle.className = 'ios-switch compact';
          newToggle.setAttribute('data-mode', 'off');
          newToggle.title = 'Switch to semantic search';

          newToggle.innerHTML = `
          <span class="label">by meaning</span>
          <input type="checkbox" />
          <span class="track"><span class="thumb"></span></span>
        `;

          container.insertBefore(newToggle, helpBtn.nextSibling);
        }

        const finalToggle = document.getElementById('btn-semantic');
        const checkbox = finalToggle.querySelector('input[type="checkbox"]');
        // No need to update label text anymore since it's static
        window.__TW_SEMANTIC_MODE__ = false;

        function setToggle(on, disabled = false) {
          finalToggle.dataset.mode = on ? 'on' : 'off';
          checkbox.checked = on;
          finalToggle.style.opacity = disabled ? '0.6' : '1';
        }

        finalToggle.addEventListener('click', async (e) => {
          e.preventDefault();

          const installed = await panel.isInstalled();
          if (!installed) {
            panel.show();
            setToggle(false, true); // Show as disabled during install
            finalToggle.style.pointerEvents = 'none';
            try {
              panel.onInstalled = () => {
                finalToggle.style.pointerEvents = '';
                window.__TW_SEMANTIC_MODE__ = true;
                setToggle(true);
                const q = document.getElementById('q');
                if (q) {
                  q.value = '';
                  q.placeholder = 'Type a semantic query (meaning-based)…';
                  q.focus();
                }
                if (window.clearResults) window.clearResults?.();
              };
              await panel.start();
            } catch (e) {
              finalToggle.style.pointerEvents = '';
              setToggle(false);
              console.error(e);
            }
            return;
          }

          const on = finalToggle.dataset.mode !== 'on';
          window.__TW_SEMANTIC_MODE__ = on;
          setToggle(on);
          const q = document.getElementById('q');
          if (q) {
            q.value = '';
            q.placeholder = on ? 'Type a semantic query (meaning-based)…' : 'Type exact/regex/wildcards…';
            q.focus();
          }
          if (window.clearResults) window.clearResults?.();
        });

        // Set initial state
        (async () => setToggle(await panel.isInstalled() && window.__TW_SEMANTIC_MODE__))();
      }, 100);
    });
  </script>

</body>

</html>