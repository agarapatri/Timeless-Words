<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book — Timeless Words</title>
    <link rel="stylesheet" href="assets/styles.css">
  </head>
  <body>
    <div class="mini-header">
      <div class="container">
        <a class="brand" href="index.html">Timeless Words</a>
        <a href="search.html">Deep Search</a>
      </div>
    </div>

    <main class="container book-page">
      <a class="back-link" href="index.html">← Back to Library</a>

      <!-- Book header -->
      <section id="bookHero" class="book-hero" aria-labelledby="bookTitle">
        <div id="bookCover" class="book-cover notranslate" translate="no" aria-hidden="true"></div>
        <div class="book-info">
          <h1 id="bookTitle" class="title"></h1>
          <div id="bookAuthor" class="muted"></div>
          <div id="bookCounts" class="muted"></div>
        </div>
      </section>

      <h2 class="section-title" style="margin-top:18px">Contents</h2>
      <div id="chaptersList" class="chapter-list"></div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <small>Inspired by <a href="https://vedabase.io/en/" target="_blank" rel="noopener">vedabase.io</a></small>
      </div>
    </footer>

    <script src="assets/data-bundle.js"></script>
    <script src="assets/app.js?v=3"></script>
    <script>
      // Helpers shared with home page
      function initialsFromTitle(title='') {
        const parts = String(title).trim().split(/\s+/).filter(Boolean).slice(0,2);
        if (!parts.length) return '';
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }

      window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(location.search);
        const id = params.get('book');

        // 1) Load metadata
        const library = await window.Library.loadLibrary();
        const meta = library.find(b => b.id === id) || library[0];

        // 2) Header: cover/title/author/counts
        const cover = document.getElementById('bookCover');
        if (meta.image) {
          cover.classList.add('has-image');
          cover.style.backgroundImage = `url('${meta.image}')`;
        } else {
          cover.textContent = initialsFromTitle(meta.title);
        }

        document.getElementById('bookTitle').textContent = meta.title || '';
        document.getElementById('bookAuthor').textContent = `by ${meta.author || 'Unknown'}`;

        // 3) Load all verses (flat rows) to compute per-chapter counts
        const rows = await window.Library.loadBookRows(meta.id);

        const byChapter = new Map();
        for (const r of rows) {
          const key = String(r.chapter);
          if (!byChapter.has(key)) byChapter.set(key, []);
          byChapter.get(key).push(r);
        }
        const chapters = Array.from(byChapter.entries())
          .map(([num, arr]) => ({
            number: Number(num),
            title: `Chapter ${num}`,
            verses: arr.sort((a,b)=>Number(a.verse)-Number(b.verse))
          }))
          .sort((a,b)=>a.number-b.number);

        // counts line like "12 chapters · 591 verses"
        const chapCount = chapters.length;
        const verseCount = rows.length;
        document.getElementById('bookCounts').textContent =
          `${chapCount} ${chapCount===1?'chapter':'chapters'} · ${verseCount} ${verseCount===1?'verse':'verses'}`;

        // 4) Render chapter cards
        const list = document.getElementById('chaptersList');
        list.innerHTML = '';
        chapters.forEach(ch => {
          const a = document.createElement('a');
          a.className = 'chapter-card';
          a.href = `chapter.html?book=${encodeURIComponent(meta.id)}&c=${encodeURIComponent(ch.number)}`;
          a.innerHTML = `
            <div class="chapter-title">Chapter ${ch.number}: ${ch.title}</div>
            <div class="chapter-sub muted">${ch.verses.length} ${ch.verses.length===1?'verse':'verses'}</div>
          `;
          list.appendChild(a);
        });
      });
    </script>
  </body>
</html>
