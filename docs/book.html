<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book — Timeless Words</title>
    <link rel="stylesheet" href="assets/styles.css">
  </head>
  <body>
    <div class="mini-header">
      <div class="container">
        <a class="brand" href="index.html">Timeless Words</a>
        <a href="search.html">Deep Search</a>
      </div>
    </div>

    <main class="container book-page">
      <a class="back-link" href="index.html">← Back to Library</a>

      <!-- Book header -->
      <section id="bookHero" class="book-hero" aria-labelledby="bookTitle">
        <div id="bookCover" class="book-cover notranslate" translate="no" aria-hidden="true"></div>
        <div class="book-info">
          <h1 id="bookTitle" class="title"></h1>
          <div id="bookAuthor" class="muted"></div>
          <div id="bookCounts" class="muted"></div>
        </div>
      </section>

      <h2 class="section-title" style="margin-top:18px">Contents</h2>
      <div id="chaptersList" class="chapter-list"></div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <small>Inspired by <a href="https://vedabase.io/en/" target="_blank" rel="noopener">vedabase.io</a></small>
      </div>
    </footer>

    <script src="assets/app.js?v=3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      // Helpers shared with home page
      function initialsFromTitle(title='') {
        const parts = String(title).trim().split(/\s+/).filter(Boolean).slice(0,2);
        if (!parts.length) return '';
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }

      function plural(n, s) { return `${n} ${n === 1 ? s : s + 's'}`; }

      window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(location.search);
        const q = params.get('book') || '';

        async function loadDb() {
          const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
          const res = await fetch(`data/library.sqlite?v=${Date.now()}`, { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to fetch SQLite');
          const buf = new Uint8Array(await res.arrayBuffer());
          return new SQL.Database(buf);
        }

        function findWork(db, token) {
          const isNumeric = /^\d+$/.test(token);
          if (isNumeric) {
            const out = db.exec(`SELECT work_id, slug, title_en, author FROM works WHERE work_id=${Number(token)} LIMIT 1`);
            if (out[0]?.values?.length) return out[0].values[0];
          }
          // by slug
          const esc = String(token).replace(/'/g, "''");
          let out = db.exec(`SELECT work_id, slug, title_en, author FROM works WHERE slug='${esc}' LIMIT 1`);
          if (out[0]?.values?.length) return out[0].values[0];
          // fallback by exact title_en (case-insensitive)
          out = db.exec(`SELECT work_id, slug, title_en, author FROM works WHERE lower(title_en)=lower('${esc}') LIMIT 1`);
          return out[0]?.values?.[0] || null;
        }

        const db = await loadDb();
        const row = findWork(db, q);
        if (!row) {
          console.error('Book not found in DB:', q);
          return;
        }
        const work_id = row[0];
        const slug = row[1];
        const title = row[2] || '';
        const author = row[3] || 'Unknown';

        // Header: cover/title/author
        const cover = document.getElementById('bookCover');
        cover.textContent = initialsFromTitle(title);
        document.getElementById('bookTitle').textContent = title;
        document.getElementById('bookAuthor').textContent = `by ${author}`;

        // Counts (chapters and verses)
        const countsOut = db.exec(`SELECT COUNT(DISTINCT division_id) AS chapters, COUNT(*) AS verses FROM verses WHERE work_id=${Number(work_id)}`);
        const countsVal = countsOut[0]?.values?.[0] || [0,0];
        const chapterCount = countsVal[0] || 0;
        const verseCount = countsVal[1] || 0;
        document.getElementById('bookCounts').textContent = `${plural(chapterCount,'chapter')} · ${plural(verseCount,'verse')}`;

        // Chapters list with verse counts
        const chOut = db.exec(`
          SELECT d.division_id, d.ordinal, d.label, COUNT(v.verse_id) AS verses
          FROM divisions d
          JOIN verses v ON v.division_id = d.division_id
          WHERE d.work_id = ${Number(work_id)}
          GROUP BY d.division_id
          ORDER BY d.ordinal
        `);
        const chapters = (chOut[0]?.values || []).map(r => ({ id: r[0], number: r[1], label: r[2] || `Chapter ${r[1]}`, verses: r[3] || 0 }));

        const list = document.getElementById('chaptersList');
        list.innerHTML = '';
        chapters.forEach(ch => {
          const a = document.createElement('a');
          a.className = 'chapter-card';
          const bookParam = String(work_id); // use numeric for stability
          a.href = `chapter.html?book=${encodeURIComponent(bookParam)}&d=${encodeURIComponent(ch.id)}`;
          a.innerHTML = `
            <div class="chapter-title">Chapter ${ch.number}: ${ch.label}</div>
            <div class="chapter-sub muted">${plural(ch.verses,'verse')}</div>
          `;
          list.appendChild(a);
        });
      });
    </script>
  </body>
</html>
