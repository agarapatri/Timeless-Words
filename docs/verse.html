<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Verse — Timeless Words</title>
  <link rel="stylesheet" href="assets/styles.css?v={{VERSION}}">
    <meta id="favicon-slot">
  </head>
  <body>
    

    <main class="container verse-page">
      <nav class="crumbs" id="crumbs"></nav>
      <div class="verse-head" style="position:relative;">
        <h1 id="ref" class="verse-ref notranslate" translate="no" style="margin:0"></h1>
        <div id="menuSlot-verse" class="menu-wrap" style="position:absolute; right:0; top:50%; transform:translateY(-50%);"></div>
      </div>

      <section class="verse-block">
        <h2>Sanskrit (Devanāgarī)</h2>
        <pre id="devanagari" class="devanagari"></pre>
      </section>
      <section class="verse-block">
        <h2>Sanskrit (IAST)</h2>
        <pre id="iast" class="iast"></pre>
      </section>
      <section class="verse-block">
        <h2>Word-for-word</h2>
        <ul id="wfw" class="wfw"></ul>
      </section>
      <section class="verse-block">
        <h2>Translation</h2>
        <p id="translation" class="translation"></p>
      </section>

      <div class="pager" id="verseNav" style="justify-content: space-between;">
        <a id="prevVerse" class="btn ghost nav-btn" href="#">‹ Prev verse</a>
        <a id="nextVerse" class="btn ghost nav-btn" href="#">Next verse ›</a>
      </div>
    </main>
    <footer class="site-footer">
      <div class="container">
        <small>Inspired by <a href="https://vedabase.io/en/" target="_blank" rel="noopener">vedabase.io</a></small>
      </div>
    </footer>

  <script src="assets/app.js?v={{VERSION}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      if (window.Library && window.Library.injectMenu) window.Library.injectMenu('#menuSlot-verse');
      window.addEventListener('DOMContentLoaded', async () => {
        const p = new URLSearchParams(location.search);
        const bookParam = p.get('book'); // numeric work_id preferred
        const divisionParam = p.get('d');
        const chapterParam = p.get('c'); // fallback
        const verseOrd = Number(p.get('v') || 1);

        async function loadDb() {
          const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
          const res = await fetch(`data/library.sqlite?v=${Date.now()}`, { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to fetch SQLite');
          const buf = new Uint8Array(await res.arrayBuffer());
          return new SQL.Database(buf);
        }

        function findWork(db, token) {
          const isNumeric = /^\d+$/.test(token || '');
          if (isNumeric) {
            const out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE work_id=${Number(token)} LIMIT 1`);
            if (out[0]?.values?.length) return out[0].values[0];
          }
          const esc = String(token || '').replace(/'/g, "''");
          let out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE slug='${esc}' LIMIT 1`);
          if (out[0]?.values?.length) return out[0].values[0];
          out = db.exec(`SELECT work_id, slug, title_en FROM works WHERE lower(title_en)=lower('${esc}') LIMIT 1`);
          return out[0]?.values?.[0] || null;
        }

        try {
          const db = await loadDb();
          const work = findWork(db, bookParam);
          if (!work) throw new Error('Work not found: ' + bookParam);
          const work_id = work[0];
          const title = work[2] || '';

          // Resolve division (chapter)
          let division_id, division_ord;
          if (divisionParam) {
            const di = db.exec(`SELECT division_id, ordinal FROM divisions WHERE division_id=${Number(divisionParam)} AND work_id=${Number(work_id)} LIMIT 1`);
            const rowd = di[0]?.values?.[0];
            if (!rowd) throw new Error('Division not found (by id)');
            division_id = rowd[0];
            division_ord = rowd[1];
          } else {
            const ord = Number(chapterParam || 1);
            const di = db.exec(`SELECT division_id, ordinal FROM divisions WHERE work_id=${Number(work_id)} AND ordinal=${ord} LIMIT 1`);
            const rowd = di[0]?.values?.[0];
            if (!rowd) throw new Error('Division not found (by ordinal)');
            division_id = rowd[0];
            division_ord = rowd[1];
          }

          // Find verse row by ordinal within this division
          const vrow = db.exec(`SELECT verse_id, ref_citation, ordinal FROM verses WHERE work_id=${Number(work_id)} AND division_id=${Number(division_id)} AND ordinal=${Number(verseOrd)} LIMIT 1`);
          const v = vrow[0]?.values?.[0];
          if (!v) throw new Error('Verse not found');
          const verse_id = v[0];
          const ref = v[1] || `${division_ord}.${verseOrd}`;

          // Load verse texts from the wide view
          const trow = db.exec(`
            SELECT COALESCE(sa_deva,''), COALESCE(sa_iast,''), COALESCE(en_translation,'')
            FROM verse_texts_wide WHERE verse_id=${Number(verse_id)} LIMIT 1
          `);
          const tvals = trow[0]?.values?.[0] || ['', '', ''];
          const sa_deva = tvals[0];
          const sa_iast = tvals[1];
          const en = tvals[2];

          // Word-for-word from tokens + verse_glosses
          const wfwOut = db.exec(`
            SELECT t.pos, t.surface,
                   (SELECT gloss FROM verse_glosses g WHERE g.verse_id=t.verse_id AND g.surface=t.surface LIMIT 1) AS gloss
            FROM tokens t WHERE t.verse_id=${Number(verse_id)} ORDER BY t.pos
          `);
          const pairs = (wfwOut[0]?.values || []).map(r => [r[1] || '', r[2] || '']);

          // Render header + crumbs
          const short = (title || '').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
          document.getElementById('ref').textContent = `${short} ${ref}`;
          const crumbs = document.getElementById('crumbs');
          crumbs.innerHTML = `
            <a href="index.html">Timeless Words</a>
            <span>›</span>
            <a href="book.html?book=${encodeURIComponent(String(work_id))}">${title}</a>
            <span>›</span>
            <a href="chapter.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(division_id))}">Chapter ${division_ord}</a>
          `;

          // Fill sections
          document.getElementById('devanagari').textContent = sa_deva || '';
          document.getElementById('iast').textContent = sa_iast || '';

          const wfw = document.getElementById('wfw');
          wfw.innerHTML = '';
          pairs.forEach(([sk, gloss]) => {
            if (!sk && !gloss) return;
            const li = document.createElement('li');
            li.innerHTML = `<span class="sk">${sk}</span> &mdash; <span class="en">${gloss}</span>`;
            wfw.appendChild(li);
          });
          document.getElementById('translation').textContent = en || '';

          // Prev/Next verse navigation across chapters
          const prevQ = db.exec(`
            SELECT vs.verse_id, d.division_id, d.ordinal AS cord, vs.ordinal AS vord
            FROM verses vs
            JOIN divisions d ON d.division_id = vs.division_id
            WHERE vs.work_id=${Number(work_id)}
              AND (d.ordinal < ${Number(division_ord)} OR (d.ordinal = ${Number(division_ord)} AND vs.ordinal < ${Number(verseOrd)}))
            ORDER BY d.ordinal DESC, vs.ordinal DESC
            LIMIT 1
          `);
          const nextQ = db.exec(`
            SELECT vs.verse_id, d.division_id, d.ordinal AS cord, vs.ordinal AS vord
            FROM verses vs
            JOIN divisions d ON d.division_id = vs.division_id
            WHERE vs.work_id=${Number(work_id)}
              AND (d.ordinal > ${Number(division_ord)} OR (d.ordinal = ${Number(division_ord)} AND vs.ordinal > ${Number(verseOrd)}))
            ORDER BY d.ordinal ASC, vs.ordinal ASC
            LIMIT 1
          `);
          const prev = prevQ[0]?.values?.[0];
          const next = nextQ[0]?.values?.[0];

          const prevEl = document.getElementById('prevVerse');
          const nextEl = document.getElementById('nextVerse');
          if (prev) {
            const dId = prev[1], vOrd = prev[3];
            prevEl.href = `verse.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(dId))}&v=${encodeURIComponent(String(vOrd))}`;
            prevEl.style.visibility = 'visible';
          } else {
            prevEl.style.visibility = 'hidden';
          }
          if (next) {
            const dId = next[1], vOrd = next[3];
            nextEl.href = `verse.html?book=${encodeURIComponent(String(work_id))}&d=${encodeURIComponent(String(dId))}&v=${encodeURIComponent(String(vOrd))}`;
            nextEl.style.visibility = 'visible';
          } else {
            nextEl.style.visibility = 'hidden';
          }
        } catch (err) {
          console.error('Verse load error', err);
        }
      });
    </script>
  </body>
  </html>
