<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapter — Timeless Words</title>

  <!-- Correct path -->
  <link rel="stylesheet" href="../assets/css/styles.css?v=036b4d8f" />
  <meta id="favicon-slot">

  <style>
    /* Minimal page-specific styles */
    .chapter-page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    .crumbs {
      display: flex;
      gap: 8px;
      align-items: center;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .crumbs a {
      color: inherit;
      text-decoration: none;
    }

    .titlebar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .titlebar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .titlebar .title {
      margin: 8px 0;
    }

    .view-select {
      padding: 8px 12px;
      border: 1px solid currentColor;
      border-radius: 999px;
      background: var(--bg);
      color: var(--fg);
      font: inherit;
    }

    .results-list {
      list-style: none;
      padding: 0;
      margin: 16px 0 40px;
      display: grid;
      gap: 12px;
    }

    .results-list>li a {
      display: block;
      padding: 16px;
      border-radius: 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      text-decoration: none;
      color: inherit;
    }

    .results-list .line+.line {
      margin-top: 6px;
    }

    .ref {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .muted {
      color: var(--muted);
      margin: 0;
    }
  </style>
</head>

<body>
  <main class="container chapter-page">
    <nav class="crumbs" id="crumbs" aria-label="Breadcrumb"></nav>

    <!-- Title row with single-select filter -->
    <div class="titlebar">
      <h1 class="title" id="chapterTitle">Chapter</h1>
      <div class="titlebar-actions">
        <select id="viewMode" class="view-select" aria-label="Filter verse view">
          <option value="en" selected>English translation</option>
          <option value="dev">Devanāgarī</option>
          <option value="iast">IAST</option>
          <option value="wfw">Word-for-word</option>
        </select>
        <div id="menuSlot-chapter" class="menu-wrap"></div>
      </div>
    </div>

    <p class="muted" id="chapterMeta"></p>
    <ol id="verseList" class="results-list"></ol>
  </main>

  <div id="footerSlot"></div>

  <script type="module">
    import { injectFooter } from '../js/footer.js';
    injectFooter('#footerSlot');
  </script>

  <script src="../js/wasm_no_threads_fallback.js"></script>
  <script src="../js/lockdown_warning.js"></script>
  <script src="../js/sql_helpers/sql-wasm.js?v=036b4d8f"></script>

  <!-- App helpers (kept) -->
  <script type="module" src="../js/app.js?v=036b4d8f"></script>
  <script type="module">
    import { loadDb, findWork } from '../js/db.js';

    if (window.Library && window.Library.injectMenu) window.Library.injectMenu('#menuSlot-chapter');
    // Query param helper
    function qp(name) { return new URLSearchParams(location.search).get(name); }

    // Persist the selected mode
    function getSavedMode() {
      try { return localStorage.getItem('tw.viewMode') || 'en'; } catch { return 'en'; }
    }
    function saveMode(mode) { try { localStorage.setItem('tw.viewMode', mode); } catch { } }

    window.addEventListener('DOMContentLoaded', async () => {
      const bookParam = qp('book');
      const divisionParam = qp('d');
      const chapterNum = Number(qp('c') || 1);

      const db = await loadDb();
      const work = await findWork(bookParam);
      if (!work) { console.error('Work not found', bookParam); return; }
      const [work_id, slug, title] = work;

      // Resolve division (chapter)
      let division_id, division_label, division_ord;

      let di;
      if (divisionParam) {
        di = await db.query(
          `SELECT division_id, ordinal, label
          FROM divisions
          WHERE division_id = $div AND work_id = $work
          LIMIT 1`,
          { $div: Number(divisionParam), $work: Number(work_id) }
        );
      } else {
        di = await db.query(
          `SELECT division_id, ordinal, label
          FROM divisions
          WHERE work_id = $work AND ordinal = $ord
          LIMIT 1`,
          { $work: Number(work_id), $ord: Number(chapterNum) }
        );
      }

      const rowd = di.rows?.[0];
      if (!rowd) {
        console.error(divisionParam ? 'Division not found by id' : 'Division not found by ordinal',
          divisionParam ? { work_id, divisionParam } : { work_id, chapterNum });
        return;
      }

      division_id = rowd[0];
      division_ord = rowd[1];
      division_label = rowd[2] || `Chapter ${rowd[1]}`;

      // Header + crumbs
      const chapterOrdinal = division_ord || chapterNum;
      const chapterLabel = division_label ? division_label : `Chapter ${chapterOrdinal}`;
      document.getElementById('chapterTitle').textContent = chapterLabel;
      const crumbs = document.getElementById('crumbs');
      const backBookParam = String(work_id);
      crumbs.innerHTML = `
        <a href="../index.html">Timeless Words</a>
        <span class="crumbs__sep" aria-hidden="true">›</span>
        <a href="book.html?book=${encodeURIComponent(backBookParam)}">${title}</a>
        <span class="crumbs__sep" aria-hidden="true">›</span>
        <span aria-current="page">${chapterLabel}</span>
      `;

      // Load verses for this division using the wide view
      const versesOut = await db.query(
        `SELECT
            vw.verse_id,
            vw.ref_citation,
            vs.ordinal,
            COALESCE(vw.sa_deva, '') AS sa_deva,
            COALESCE(vw.sa_iast, '') AS sa_iast,
            COALESCE(vw.en_translation, '') AS en
        FROM verse_texts_wide vw
        JOIN verses vs ON vs.verse_id = vw.verse_id
        WHERE vw.work_id = $work AND vw.division_id = $div
        ORDER BY vs.ordinal`,
        { $work: Number(work_id), $div: Number(division_id) }
      );
      const rows = (versesOut.rows || []).map(r => ({
        verse_id: r[0],
        ref: r[1],
        ordinal: r[2],
        sa_deva: r[3],
        sa_iast: r[4],
        en: r[5]
      }));

      // Build WFW map for this division
      const wfwMap = new Map();
      const wfwOut = await db.query(
        `SELECT t.verse_id, t.pos, t.surface,
                (SELECT gloss
                  FROM verse_glosses g
                  WHERE g.verse_id = t.verse_id
                    AND g.surface  = t.surface
                  LIMIT 1) AS gloss
          FROM tokens t
          JOIN verses v ON v.verse_id = t.verse_id
          WHERE v.division_id = $div
          ORDER BY t.verse_id, t.pos`,
        { $div: Number(division_id) }
      );
      if (wfwOut.rows) {
        for (const [verse_id, pos, surface, gloss] of wfwOut.rows) {
          const key = Number(verse_id);
          if (!wfwMap.has(key)) wfwMap.set(key, []);
          wfwMap.get(key).push([surface || '', gloss || '']);
        }
      }

      // Meta counts
      document.getElementById('chapterMeta').textContent = `${rows.length} ${rows.length === 1 ? 'verse' : 'verses'}`;

      // Render
      const list = document.getElementById('verseList');
      const modeSel = document.getElementById('viewMode');
      const initialMode = getSavedMode();
      modeSel.value = ['en', 'dev', 'iast', 'wfw'].includes(initialMode) ? initialMode : 'en';

      function asSnippet(row, mode) {
        if (mode === 'dev') return row.sa_deva || '';
        if (mode === 'iast') return row.sa_iast || '';
        if (mode === 'wfw') {
          const pairs = wfwMap.get(Number(row.verse_id)) || [];
          return pairs.map(([sk, en]) => `${sk} — ${en}`).join('; ');
        }
        return row.en || '';
      }

      function render() {
        const mode = modeSel.value;
        list.innerHTML = '';
        rows.forEach(r => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `verse.html?book=${encodeURIComponent(backBookParam)}&d=${encodeURIComponent(division_id)}&v=${encodeURIComponent(r.ordinal)}`;
          const snippet = asSnippet(r, mode);
          // ref: use work short ID equivalent; we don't have short here, so display first two letters of title
          const short = (title || '').split(/\s+/).map(s => s[0]).join('').slice(0, 2).toUpperCase();
          a.innerHTML = `
            <div class="line"><span class="ref notranslate" translate="no">${short} ${division_ord || chapterNum}.${r.ordinal}</span></div>
            <div class="line">${(snippet || '').replace(/\n/g, '<br>')}</div>
          `;
          li.appendChild(a);
          list.appendChild(li);
        });
      }

      modeSel.addEventListener('change', () => { saveMode(modeSel.value); render(); });
      render();
    });
  </script>

</body>

</html>
